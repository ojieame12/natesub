generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum SubscriptionStatus {
  active
  canceled
  past_due
  paused
}

enum SubscriptionInterval {
  month
  one_time
}

enum PaymentStatus {
  pending
  otp_pending   // Transfer requires OTP finalization (Paystack)
  succeeded
  failed
  refunded
  disputed      // Dispute opened, funds held
  dispute_won   // Dispute resolved in our favor
  dispute_lost  // Dispute lost, funds gone
}

enum PaymentType {
  recurring
  one_time
  refund        // Refund transaction (negative amount)
  dispute       // Dispute-related transaction
  payout        // Creator payout transfer (progressive fee model)
}

enum RequestStatus {
  draft
  sent
  pending_payment  // User clicked accept, awaiting payment completion
  accepted         // Payment succeeded
  declined
  expired          // Checkout session expired without payment
}

enum RequestSendMethod {
  email
  sms
  link
}

enum Relationship {
  family
  friend
  client
  fan
  colleague
  partner
  other
}

enum UpdateStatus {
  draft
  sent
}

enum PayoutStatus {
  pending
  active
  restricted
}

enum Purpose {
  tips
  support
  allowance
  fan_club
  exclusive_content
  service
  other
}

enum PricingModel {
  single
  tiers
}

enum PaymentProvider {
  stripe
  paystack
  flutterwave
}

enum PayrollPeriodType {
  weekly
  biweekly
  monthly
}

enum OnboardingBranch {
  personal
  service
}

enum FeeMode {
  absorb            // Creator absorbs fee, subscriber pays exact price
  pass_to_subscriber // Fee added on top, creator keeps full amount
}

// ============================================
// USER & PROFILE
// ============================================

model User {
  id          String    @id @default(uuid())
  email       String    @unique
  createdAt   DateTime  @default(now())
  lastLoginAt DateTime?
  deletedAt   DateTime? // Soft delete timestamp

  // Onboarding state (server-side tracking)
  onboardingStep   Int?              // Last completed step (0-11)
  onboardingBranch OnboardingBranch? // 'personal' | 'service'
  onboardingData   Json?             // Partial form data for recovery

  profile          Profile?
  subscriptions    Subscription[] @relation("Creator")
  subscribedTo     Subscription[] @relation("Subscriber")
  requests         Request[]
  updates          Update[]
  updateDeliveries UpdateDelivery[]
  activities       Activity[]
  sessions         Session[]
  payrollPeriods   PayrollPeriod[]

  @@map("users")
}

model Profile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Identity
  username      String  @unique
  displayName   String
  bio           String?
  avatarUrl     String?
  voiceIntroUrl String?
  phone         String?  // Phone number for SMS notifications (E.164 format)

  // Location
  country     String
  countryCode String
  currency    String @default("USD")

  // Purpose
  purpose Purpose

  // Pricing
  pricingModel PricingModel
  singleAmount Int? // in cents
  tiers        Json? // array of tier objects
  feeMode      FeeMode @default(pass_to_subscriber) // Who pays the platform fee

  // Perks & Impact
  perks       Json? // array of perk objects
  impactItems Json? // array of impact items

  // Payments - Stripe
  paymentProvider PaymentProvider?
  stripeAccountId String?          @unique
  payoutStatus    PayoutStatus     @default(pending)

  // Payments - Paystack (for NG, KE, ZA)
  paystackSubaccountCode String?   @unique  // "ACCT_xxxxx"
  paystackBankCode       String?            // Bank code for payouts
  paystackAccountNumber  String?            // Creator's bank account
  paystackAccountName    String?            // Verified name from resolve API

  // Platform Subscription (for service users - $5/mo, first month free)
  platformCustomerId       String?  @unique  // Stripe customer ID for the creator
  platformSubscriptionId   String?  @unique  // Stripe subscription ID for $5/mo
  platformSubscriptionStatus String? // trialing, active, past_due, canceled
  platformTrialEndsAt      DateTime? // When the free trial ends
  platformDebitCents       Int      @default(0) // Accumulated platform debt to recover from earnings

  // Public URL
  shareUrl String?

  // Settings
  notificationPrefs Json? // { push: bool, email: bool, subscriberAlerts: bool, paymentAlerts: bool }
  isPublic          Boolean @default(true) // Profile visibility

  // Template
  template String @default("boundary") // Subscribe page template: boundary, minimal, editorial

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("profiles")
}

// ============================================
// AUTH
// ============================================

model Session {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([token])
  @@map("sessions")
}

model MagicLinkToken {
  id        String    @id @default(uuid())
  email     String
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([tokenHash])
  @@map("magic_link_tokens")
}

// ============================================
// SUBSCRIPTIONS & PAYMENTS
// ============================================

model Subscription {
  id String @id @default(uuid())

  // Who is subscribing to whom
  subscriberId String
  subscriber   User   @relation("Subscriber", fields: [subscriberId], references: [id], onDelete: Cascade)
  creatorId    String
  creator      User   @relation("Creator", fields: [creatorId], references: [id], onDelete: Cascade)

  // Subscription details
  tierId   String?
  tierName String?
  amount   Int // cents
  currency String
  interval SubscriptionInterval

  // Status
  status            SubscriptionStatus @default(active)
  currentPeriodEnd  DateTime?
  cancelAtPeriodEnd Boolean            @default(false)

  // Stripe
  stripeSubscriptionId String? @unique
  stripeCustomerId     String?

  // Paystack (for recurring charges)
  paystackAuthorizationCode String?  // Authorization for recurring charges
  paystackCustomerCode      String?  // Paystack customer ID

  // Async payment follow-up (for bank transfers, SEPA, etc.)
  // These are set during checkout.session.completed for async payments
  // and used by invoice.paid to complete conversion tracking and request acceptance
  asyncViewId    String?  // PageView ID to mark as converted
  asyncRequestId String?  // Request ID to mark as accepted

  // Metrics
  ltvCents Int @default(0)

  // Fee tracking (locked at subscription creation for consistent renewals)
  feeModel String? // 'flat' for new, null for legacy
  feeMode  String? // 'absorb' | 'pass_to_subscriber' - who pays the platform fee

  // Timestamps
  startedAt  DateTime  @default(now())
  canceledAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  payments         Payment[]
  notificationLogs NotificationLog[]

  @@unique([subscriberId, creatorId, interval])  // Prevent duplicate subs per interval type
  @@index([creatorId])
  @@index([subscriberId])
  @@map("subscriptions")
}

model Payment {
  id String @id @default(uuid())

  subscriptionId String?
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  creatorId      String
  subscriberId   String?

  // Amount (subscriber-pays model)
  grossCents  Int?           // Total subscriber paid (amount + fee) - new model
  amountCents Int            // Creator's price (legacy: total paid, new: same as netCents)
  currency    String
  feeCents    Int @default(0) // Service fee taken by platform
  netCents    Int             // What creator receives
  platformDebitRecoveredCents Int @default(0) // Platform debt recovered from this payment

  // Fee metadata (for auditing)
  feeModel         String?   // 'progressive_v1', 'legacy_percent', null for old
  feeEffectiveRate Float?    // 0.0575 for 5.75%
  feeWasCapped     Boolean @default(false)

  // Provider fees (for reconciliation - what Stripe/Paystack charges us)
  providerFeeCents   Int?    // Processing fee charged by payment provider
  providerTransferFeeCents Int? // Transfer/payout fee (Paystack only)

  // Type & Status
  type   PaymentType
  status PaymentStatus

  // Stripe (stripe_event_id for webhook idempotency)
  stripePaymentIntentId String? @unique
  stripeChargeId        String?
  stripeDisputeId       String? @unique // For tracking disputes/chargebacks
  stripeEventId         String? @unique

  // Paystack (paystack_event_id for webhook idempotency)
  paystackEventId        String? @unique
  paystackTransactionRef String? @unique
  paystackTransferCode   String?  // Transfer code for OTP finalization

  // Timestamps
  occurredAt DateTime @default(now())
  createdAt  DateTime @default(now())

  @@index([creatorId])
  @@index([stripeEventId])
  @@index([paystackEventId])
  @@map("payments")
}

// ============================================
// REQUESTS
// ============================================

model Request {
  id        String @id @default(uuid())
  creatorId String
  creator   User   @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  // Recipient (may not be a user)
  recipientName  String
  recipientEmail String?
  recipientPhone String?
  relationship   Relationship

  // Request details
  amountCents Int
  currency    String
  isRecurring Boolean @default(false)
  message     String?
  voiceUrl    String?
  customPerks Json?
  dueDate     DateTime? // For service invoices

  // Delivery
  sendMethod RequestSendMethod?
  status     RequestStatus      @default(draft)

  // Public token for recipient link
  publicToken     String?         // Encrypted raw token for reminder links
  publicTokenHash String? @unique // Hashed for lookup
  tokenExpiresAt  DateTime?

  // Payment tracking
  stripeCheckoutSessionId String? @unique  // Links to Stripe checkout session
  paystackTransactionRef  String? @unique  // Links to Paystack transaction

  // Timestamps
  sentAt      DateTime?
  respondedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([creatorId])
  @@index([publicTokenHash])
  @@index([stripeCheckoutSessionId])
  @@index([paystackTransactionRef])
  @@map("requests")
}

// ============================================
// UPDATES
// ============================================

model Update {
  id        String @id @default(uuid())
  creatorId String
  creator   User   @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  // Content
  title    String?
  body     String
  photoUrl String?

  // Targeting: all, supporters, vip, or specific tier ID
  audience String

  // Status
  status UpdateStatus @default(draft)

  // Stats
  recipientCount Int @default(0)
  viewCount      Int @default(0)

  // Timestamps
  sentAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  deliveries UpdateDelivery[]

  @@index([creatorId])
  @@map("updates")
}

// Track delivery status per subscriber for updates
model UpdateDelivery {
  id        String @id @default(uuid())
  updateId  String
  update    Update @relation(fields: [updateId], references: [id], onDelete: Cascade)

  subscriberId String
  subscriber   User   @relation(fields: [subscriberId], references: [id], onDelete: Cascade)

  // Delivery status
  status    UpdateDeliveryStatus @default(pending)
  channel   String               @default("email") // email, sms
  error     String?              // Error message if failed

  // Tracking
  sentAt    DateTime?
  openedAt  DateTime?

  createdAt DateTime @default(now())

  @@unique([updateId, subscriberId])
  @@index([updateId])
  @@index([subscriberId])
  @@map("update_deliveries")
}

enum UpdateDeliveryStatus {
  pending
  sent
  failed
  opened
}

// ============================================
// ACTIVITY
// ============================================

model Activity {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Type: subscription_created, payment_received, request_sent, request_accepted, update_sent
  type    String
  payload Json

  createdAt DateTime @default(now())

  @@index([userId, createdAt(sort: Desc)])
  @@map("activities")
}

// ============================================
// PAGE VIEWS & ANALYTICS
// ============================================

model PageView {
  id        String   @id @default(uuid())
  profileId String

  // Visitor info (anonymous - no PII)
  visitorHash   String?  // Hashed IP + UA for unique visitor counting
  referrer      String?  // Where they came from
  utmSource     String?  // UTM tracking
  utmMedium     String?
  utmCampaign   String?

  // Device info
  deviceType    String?  // mobile, tablet, desktop
  country       String?  // From IP geolocation

  // Conversion tracking
  reachedPayment Boolean @default(false)    // Did they swipe to payment screen?
  startedCheckout Boolean @default(false)   // Did they click subscribe?
  completedCheckout Boolean @default(false) // Did payment succeed? (redirect with ?success=true)

  createdAt DateTime @default(now())

  @@index([profileId, createdAt(sort: Desc)])
  @@index([visitorHash])
  @@map("page_views")
}

// ============================================
// NOTIFICATION LOGS (Idempotency)
// ============================================

model NotificationLog {
  id             String       @id @default(uuid())
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  type           String       // 'renewal_reminder' | 'payment_failed' | 'subscription_canceled'
  sentAt         DateTime     @default(now())

  // Unique constraint prevents duplicate sends
  @@unique([subscriptionId, type])
  @@index([subscriptionId])
  @@map("notification_logs")
}

// ============================================
// PAYROLL (Service Branch Only)
// ============================================

model PayrollPeriod {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Period boundaries
  periodStart DateTime
  periodEnd   DateTime
  periodType  PayrollPeriodType @default(biweekly)

  // Currency (single currency per period)
  currency String @default("USD")

  // Cached totals (snapshot at generation time)
  grossCents         Int // Sum of all successful payment amounts
  refundsCents       Int @default(0) // Refunds in the period
  chargebacksCents   Int @default(0) // Disputed/lost chargebacks
  platformFeeCents   Int // 8% platform fee (on adjusted gross)
  processingFeeCents Int // 2% payment processor fee
  netCents           Int // What creator received after all deductions
  paymentCount       Int // Number of successful transactions

  // YTD (as of period end)
  ytdGrossCents Int
  ytdNetCents   Int

  // Payout info
  payoutDate   DateTime?
  payoutMethod String?   // 'stripe' | 'paystack'
  bankLast4    String?   // Last 4 of bank account

  // Verification
  verificationCode String @unique // NP-2024-DEC-A3F

  // PDF storage
  pdfUrl         String?   // R2 URL once generated
  pdfGeneratedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Include currency in uniqueness to support multi-currency creators
  @@unique([userId, periodStart, periodEnd, currency])
  @@index([userId, periodStart])
  @@index([verificationCode])
  @@map("payroll_periods")
}

// ============================================
// WEBHOOK EVENTS (Audit Trail)
// ============================================

model WebhookEvent {
  id String @id @default(uuid())

  // Event identification
  provider   String // 'stripe' | 'paystack'
  eventId    String @unique // External event ID (evt_xxx or paystack event ID)
  eventType  String // 'checkout.session.completed', 'charge.success', etc.

  // Processing status
  status     String @default("received") // 'received' | 'processing' | 'processed' | 'failed' | 'skipped'
  error      String? // Error message if failed

  // Payload (for debugging/replay)
  payload    Json? // Full event payload (optional, can be large)

  // Related entities (optional - populated during processing)
  subscriptionId String?
  paymentId      String?
  userId         String? // Creator or relevant user

  // Processing metadata
  processingTimeMs Int? // How long processing took
  retryCount       Int  @default(0)

  // Timestamps
  receivedAt  DateTime @default(now())
  processedAt DateTime?
  createdAt   DateTime @default(now())

  @@index([provider, eventType])
  @@index([status])
  @@index([receivedAt])
  @@index([userId])
  @@map("webhook_events")
}

// ============================================
// REMINDERS (Multi-purpose notification scheduling)
// ============================================

enum ReminderType {
  // Request/Invoice reminders (service providers)
  request_unopened_24h    // Request sent but not opened after 24h
  request_unopened_72h    // Request sent but not opened after 72h
  request_unpaid_3d       // Request opened but not paid after 3 days
  request_expiring        // Request token expiring soon (24h before)
  invoice_due_7d          // Invoice due in 7 days
  invoice_due_3d          // Invoice due in 3 days
  invoice_due_1d          // Invoice due tomorrow
  invoice_overdue_1d      // Invoice 1 day overdue
  invoice_overdue_7d      // Invoice 7 days overdue

  // Payout notifications (creators)
  payout_completed        // Money hit their bank
  payout_failed           // Transfer failed

  // Payroll notifications
  payroll_ready           // New pay statement available

  // Onboarding/Setup reminders
  onboarding_incomplete_24h
  onboarding_incomplete_72h
  bank_setup_incomplete   // Blocking payouts

  // Engagement
  no_subscribers_7d       // No subscribers after 7 days
}

enum ReminderChannel {
  email
  sms
  push
}

enum ReminderStatus {
  scheduled
  sent
  failed
  canceled
}

model Reminder {
  id         String   @id @default(uuid())
  userId     String   // Who to remind (creator or subscriber)

  // What this reminder is about
  entityType String   // 'request' | 'subscription' | 'profile' | 'payroll' | 'payment'
  entityId   String   // The related entity ID

  // Reminder details
  type       ReminderType
  channel    ReminderChannel @default(email)
  status     ReminderStatus  @default(scheduled)

  // Scheduling
  scheduledFor DateTime  // When to send
  sentAt       DateTime? // When actually sent (null until sent)

  // Error tracking
  errorMessage String?
  retryCount   Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([entityType, entityId, type]) // One reminder per type per entity
  @@index([status, scheduledFor])        // For finding due reminders
  @@index([userId])
  @@map("reminders")
}
